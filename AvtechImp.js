// ==UserScript==
// @name          Avtech Improvements
// @namespace     http://klogzoog.com/
// @version       0.6.8.7
// @description   Avtech Dispatch Featured Unit Search and Flight Details
// @match         https://avtc.avtechcloud.com/
// @include       http://avtc.avtechcloud.com/*
// @include       https://avtc.avtechcloud.*/* 
// @copyright     2014, klogzoog
// @run-at        document-end
// @updateURL     https://raw.githubusercontent.com/klogzoog/AvtechImp/master/AvtechImp.js
// @require       https://jquery-timer.googlecode.com/svn/trunk/jquery.timer.js
// @require       http://swip.codylindley.com/jquery.popupWindow.js
// ==/UserScript==

$(function(){function p(e,t,n){var r,i,s;var o=avtc.dispatchState.openDepartureCallsGrid;var u=avtc.dispatchState.openCallsGrid;var a=avtc.dispatchState.futureCallsGrid;var f=avtc.dispatchState.inprogressCallsGrid;var l=$.grep(o._data,function(r){d=new Date(r.Time);ta=d.getTime();return ta==t&&r.FlightNumber==e&&r.Requirement==n});var c=$.grep(u._data,function(r){d=new Date(r.Time);ta=d.getTime();return ta==t&&r.FlightNumber==e&&r.Requirement==n});var h=$.grep(f._data,function(r){d=new Date(r.Time);ta=d.getTime();return ta==t&&r.FlightNumber==e&&r.Requirement==n});var p=$.grep(a._data,function(r){d=new Date(r.Time);ta=d.getTime();return ta==t&&r.FlightNumber==e&&r.Requirement==n});if(l.length!==0){r=0;i=l;s=o}else if(c.length!==0){r=0;i=c;s=u}else if(h.length!==0){r=1;i=h;s=f}else if(p.length!==0){r=2;i=p;s=a}else{r=3}var v=s._cellId;var m=v.slice(0,-12);$.each(i,function(e,t){var n=" .k-selectable tbody tr[data-uid='"+t.uid+"']";var i="#"+m+" .k-grid-content";var s="#dispatchCalls #callsTabList li:eq("+r+")";$(s).click();$(i+n+" td").mousedown();$(i+n+" td").mouseup();$(i+n+" td").trigger("click");$(i).scrollTo(n,0);$(i+n).addClass("k-state-selected")})}function v(){var e=avtc.dispatchState.dispatchDetailListView.dataSource._view[0].DepartureFlightName;var t=avtc.dispatchState.dispatchDetailListView.dataSource._view[0].ArrivalFlightName;var n=avtc.dispatchState.dispatchDetailListView.dataSource._view[0].DepartureFlightNumber;var r=avtc.dispatchState.dispatchDetailListView.dataSource._view[0].ArrivalFlightNumber;var i=avtc.dispatchState.dispatchDetailListView.dataSource._view[0].IsArriving;var s,o,u,a;if(i==true){u=t;a=r}else if(i==false){u=e;a=n}else{}var f=u.slice(0,2);var l=a;$(".example4demo").popupWindow({windowURL:"http://klogzoog.com/flights/?a="+f+"&f="+l+"&t="+i,witdh:"200",height:"200",windowName:"klogz"});$(".example4demo").click()}function m(t){var n=avtc.dispatchState.activeEmployeesGrid;var r=t;if(r){var i=new RegExp(r,"i");$("#unitSearch").blur();var s=$.grep(n._data,function(e){return i.test(e.Name)});if(n._data.length===0){$("#infov").text("Did not find any..")}$.each(s,function(t,n){var r=" .k-selectable tbody tr[data-uid='"+n.uid+"']";var i="#activeEmployeesGrid .k-grid-content";if(s.length==1){$(i+r+" td").mousedown();$(i+r+" td").mouseup();$(i+r+" td").click();console.log(n.uid);console.log(r[0])}else if(s.length>1){e=1;$("#infov").html("<small>(press the + for next)  </small>"+e+" / "+s.length)}$(i).scrollTo(r,10);$(i+r).addClass("k-state-selected");console.log(s.length)})}}function g(t){var n=avtc.dispatchState.inactiveEmployeesGrid;var r=t;if(r){var i=new RegExp(r,"i");$("#inActSearch").blur();var s=$.grep(n._data,function(e){return i.test(e.Name)});if(n._data.length===0){$("#infov").text("Did not find any..")}$.each(s,function(t,n){var r=" .k-selectable tbody tr[data-uid='"+n.uid+"']";var i="#inactiveEmployeesGrid .k-grid-content";if(s.length==1){$(i+r+" td").mousedown();$(i+r+" td").mouseup();$(i+r+" td").click();console.log(n.uid);console.log(r[0])}else if(s.length>1){e=1;$("#infov").html("<small>(press the + for next)  </small>"+e+" / "+s.length)}$(i).scrollTo(r,10);$(i+r).addClass("k-state-selected");console.log(s.length)})}}function E(){n=avtc.dispatchState.activeEmployeesGrid;datau=avtc.dispatchState.inactiveEmployeesGrid;var e=$.grep(n._data,function(e){return e.Name});$.each(e,function(e,t){b.push(t.Name)});var t=$.grep(datau._data,function(e){return e.Name});$.each(t,function(e,t){w.push(t.Name)});b.sort()}function S(){$("#unitSearch").kendoAutoComplete({dataSource:b,filter:"startswith",placeholder:"Search Unit...",highlightFirst:false,suggest:true,select:function(e){var t=e.item.text();m(t)}});$("#inActSearch").kendoAutoComplete({dataSource:w,filter:"contains",placeholder:"Search Unit...",highlightFirst:false,suggest:true,select:function(e){var t=e.item.text();g(t)}})}var n;var s=0;form='<div class="header-button-right"><span id="infov"></span><input placeholder="please wait..." type="text" id="unitSearch" value=""></div>';inActform='<div class="header-button-right"><span id="infov"></span><input placeholder="please wait..." type="text" id="inActSearch" value=""></div>';header=$("#dispatchActiveEmployeesHeader");inActheader=$("#dispatchInactiveEmployeesHeader");header.append(form);inActheader.append(inActform);$("#infov").html("<small>Press + to begin: </small>");var o;$("#dispatchActiveEmployeeDetailGrid").mouseenter(function(){o="#dispatchActiveEmployeeDetailGrid .k-grid-content .k-selectable tbody tr td"});$(o).click(function(){});var u,l,c;var h=$.timer(function(){var n;if(avtc.dispatchState.dispatchActiveEmployeeCallDetailGrid._data!==undefined){c=avtc.dispatchState.dispatchActiveEmployeeCallDetailGrid._data.length}else{}var s=c;for(i=0;i<s;i++){var o=avtc.dispatchState.dispatchActiveEmployeeCallDetailGrid._data[i].FlightNumber;var u="#dispatchActiveEmployeeDetailGrid .k-grid-content .k-selectable tbody tr:eq("+i+") td:eq(1)";$(u).html('<a data-q="'+i+'" id="flfind">'+o+"</a>");$(u).css("cursor","pointer");$("#flfind[data-q='"+i+"']").on("click",{el:i},function(n){e=n.data.el;a=avtc.dispatchState.dispatchActiveEmployeeCallDetailGrid._data[e].CallTime;r=avtc.dispatchState.dispatchActiveEmployeeCallDetailGrid._data[e].RequirementName;d=new Date(a);t=d.getTime();f=avtc.dispatchState.dispatchActiveEmployeeCallDetailGrid._data[e].FlightNumber;p(f,t,r)})}});h.set({time:1e3,autostart:true});selectorval="#callsInProgressGrid .k-grid-content .k-selectable tbody tr:eq(0)";$("#futureInfo").html('<button hidden="hidden" class="example4demo">></button>');$("#unitSearch").focus(function(){this.select();$("#infov").html("<small></small>")});$("#inActSearch").focus(function(){this.select();$("#infov").html("<small></small>")});var y=$.timer(function(){E();var e=$("#unitSearch").data("kendoAutoComplete");e.refresh()});setTimeout(function(){E();S();y.set({time:36e5,autostart:true})},4e3);var b=[];var w=[];$(document).keyup(function(t){if(t.keyCode==27){h.stop();e=0;$("#unitSearch").prop("disabled",false);$("#unitSearch").val("")}});$(window).keyup(function(e){if(e.which==107){$("#unitSearch").focus();$("#inActSearch").focus();n=avtc.dispatchState.activeEmployeesGrid}else if(e.which==192){v()}});$("#unitSearch").keyup(function(e){if(e.which==13){var t=$("#unitSearch").val();m(t)}});$("#inActSearch").keyup(function(e){if(e.which==13){var t=$("#inActSearch").val();g(t)}})})
